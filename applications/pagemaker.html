<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /> 

	<title>Systo pagemaker</title> 

	<link type="text/css" rel="stylesheet" href="/static/css/layout-default-latest.css" />

    <!-- CSS -->
    <link type="text/css" rel="stylesheet" href="../css/jquery-ui.css"/>

    <style>

#workspace {
    background-color:#f0f0ff;
    position: relative;
    height: 10000px;
    width: 10000px;
    !z-index:120;
}

.placeddiv {
    background-color: white;
    border: solid 1px black;
    width: 300px;
    height: 200px;
    position: absolute;
}

/* !http://stackoverflow.com/questions/14954104/why-jquery-ui-1-10-remove-jquery-dialog-zindex-option */
.ui-front {
    z-index:1000000 !important; /* The default is 100. !important overrides the default. */
    }
.ui-dialog {
    z-index:1000000 !important; /* The default is 100. !important overrides the default. */
    }
    </style>

    <!-- Javascript - as merged but non-minified files -->
    <script type="text/javascript" src="../js/all_core.js"></script>
    <script type="text/javascript" src="../plugins/all_plugins.js"></script>
	<script type="text/javascript" src="../widgets/all_widgets.js"></script>

    <!-- Extra libraries -->
    <script type="text/javascript" src="../js/jquery.layout-latest.js"></script>

    <!-- A model language definition, held as a Javascript object literal -->
    <script type="text/javascript" src="../languages/system_dynamics.js"></script>

    <!-- Model(s), held as a Javascript object literal -->
    <script type="text/javascript" src="../models/miniworld.js"></script>
    <script type="text/javascript" src="../models/predator_prey_shodor.js"></script>
    <script type="text/javascript" src="../models/cascade.js"></script>
    <script type="text/javascript" src="../models/two_species_sir.js"></script>

    <script>
function initDoc() {
  oDoc = document.getElementById("textBox");
  sDefTxt = oDoc.innerHTML;
  if (document.compForm.switchMode.checked) { setDocMode(true); }
}

function formatDoc(sCmd, sValue) {
  if (validateMode()) { document.execCommand(sCmd, false, sValue); oDoc.focus(); }
}

function validateMode() {
  if (!document.compForm.switchMode.checked) { return true ; }
  alert("Uncheck \"Show HTML\".");
  oDoc.focus();
  return false;
}

function setDocMode(bToSource) {
  var oContent;
  if (bToSource) {
    oContent = document.createTextNode(oDoc.innerHTML);
    oDoc.innerHTML = "";
    var oPre = document.createElement("pre");
    oDoc.contentEditable = false;
    oPre.id = "sourceText";
    oPre.contentEditable = true;
    oPre.appendChild(oContent);
    oDoc.appendChild(oPre);
  } else {
    if (document.all) {
      oDoc.innerHTML = oDoc.innerText;
    } else {
      oContent = document.createRange();
      oContent.selectNodeContents(oDoc.firstChild);
      oDoc.innerHTML = oContent.toString();
    }
    oDoc.contentEditable = true;
  }
  oDoc.focus();
}

function printDoc() {
  if (!validateMode()) { return; }
  var oPrntWin = window.open("","_blank","width=450,height=470,left=400,top=100,menubar=yes,toolbar=no,location=no,scrollbars=yes");
  oPrntWin.document.open();
  oPrntWin.document.write("<!doctype html><html><head><title>Print<\/title><\/head><body onload=\"print();\">" + oDoc.innerHTML + "<\/body><\/html>");
  oPrntWin.document.close();
}


function capture() {
    $('#textBox').attr('contenteditable','false');
    console.debug($('#textBox').html());
}
</script>

    <!-- This page's custom script -->
    <script>

    $(document).ready(function() {
        var mode = 'pointer';   // alternatives are: 'adding_widget'
        var mousedownx, mousedowny;
        var count = 0;
        var colours = {package1:'yellow', package2:'lightgreen', package3:'orange'};
        var maxZindex = 0;

        addOptionsToSelectModel();

        SYSTO.switchToModel('miniworld');

        SYSTO.state.currentPackageId = $('#select_package').val();
        SYSTO.state.currentWidgetId = $('#select_widget').val();
        SYSTO.state.currentModelId = $('#select_model').val();

        $('#select_package').on('change', function() {
            SYSTO.state.currentPackageId = this.value;
        })
        $('#select_widget').on('change', function() {
            SYSTO.state.currentWidgetId = this.value;
        })
        $('#select_model').on('change', function() {
            SYSTO.state.currentModelId = this.value;
            SYSTO.switchToModel(this.value);

                SYSTO.trigger(
                    'pagemaker.html',
                    '#workspace mousedown',
                    'change_model_listener',
                    'click',
                    [{  packageId:SYSTO.state.currentPackageId,
                        oldModelId:'',
                        newModelId:SYSTO.state.currentModelId}]
                );
                SYSTO.trigger(
                    'pagemaker.html',
                    '#workspace mousedown',
                    'display_listener',
                    'click',
                    [{  packageId:SYSTO.state.currentPackageId,
                        modelId:SYSTO.state.currentModelId
                    }]
                );
        })


        $('#textBox').
            mousedown(function(ev) {
                ev.stopPropagation();
            });

        $("#workspace").mousedown(function(e){
            mousedownx = e.pageX;
            mousedowny = e.pageY;
        });

        $("#workspace").mouseup(function(e){
            if (Math.abs(e.pageX-mousedownx)>3 ||
                    Math.abs(e.pageY-mousedowny)>3) {
                return;
            }

            var wrapper = $('#workspace').parent();
            var parentOffset = wrapper.offset(); 
            var relX = e.pageX - parentOffset.left + wrapper.scrollLeft();
            var relY = e.pageY - parentOffset.top + wrapper.scrollTop()-20;
            console.debug('\n'+relX+' = '+e.pageX+' - '+parentOffset.left+' + '+wrapper.scrollLeft());
            console.debug(relY+' = '+e.pageY+' - '+parentOffset.top+' + '+wrapper.scrollTop()+' - 20');

            var coords_eventClient = SYSTO.eventToElementCoords('eventClient', e, this);
            var coords_eventOffset = SYSTO.eventToElementCoords('eventOffset', e, this);
            var coords_eventLayer = SYSTO.eventToElementCoords('eventLayer', e, this);
            console.debug('eventClient: '+JSON.stringify(coords_eventClient));
            console.debug('eventOffset: '+JSON.stringify(coords_eventOffset));
            console.debug('eventLayer:  '+JSON.stringify(coords_eventLayer));

            relX = coords_eventClient.x;
            relY = coords_eventClient.y;

            var packageId = SYSTO.state.currentPackageId;
            var widgetId = SYSTO.state.currentWidgetId;
            var modelId = SYSTO.state.currentModelId;

            var model = SYSTO.models[modelId];
            model.workspace = {};
            model.workspace.modelChanged = false;
            SYSTO.state.currentModelId = modelId;
            console.debug('\nAdding panel for package '+packageId+'; widget '+widgetId+'; model '+modelId);
            // Create the panel
            var newDiv = $('<div/>')
                .addClass('placeddiv')
                .css({
                    left: relX,
                    top: relY,
                    //'overflow-y':'auto',
                    //'overflow-x':'auto',
                    'z-index':maxZindex
                });
            $(newDiv).mousedown(function(ev) {
                maxZindex += 2;
                $(this).css({'z-index':maxZindex});
                ev.stopPropagation();
            });
            var handle = $('<div class="handle" style="height:20px; width:20px; background-color:'+colours[packageId]+'; position:absolute; left:0px; top:0px; z-index:1000;"></div>');
            var deletor = $('<div class="deletor" style="height:20px; width:20px; background-color:red;  position:absolute; left:20px; top:0px; z-index:1000;">&nbsp;X</div>').
                mousedown(function(ev) {
                    $(newDiv).remove();
                    ev.stopPropagation();
                });
            $(newDiv).append(handle).append(deletor);
            $('#workspace').append(newDiv);    
            $(newDiv).draggable({handle:handle, containment:'#workspace'}).resizable();

            switch(widgetId) {

                case 'audio_plotter':
                    $('.body').css({height:'auto', width:'250px'});
                    $(newDiv).audio_plotter({
                        modelId:modelId,
                        includeNodeId: function(nodeId) {
                            var node = SYSTO.models[modelId].nodes[nodeId];
                            if (node.type === 'stock') {
                                return true;
                            } else {
                                return false;
                            }
                        }
                    });
                    break;

                case 'diagram':
                    $('.body').css({height:'200px', width:'300px'});
                    $(newDiv).diagram({packageId:packageId, modelId:modelId, allowEditing:false, scale:0.5});
                    break;

                case 'equation_listing':
                    $('.body').css({height:'320px', width:'auto', overflow:'auto'});
                    $(newDiv).equation_listing({modelId:modelId});
                    break;

                case 'inlineValue':
                    $(newDiv).append('<div>The final value for stock1 is '+
                        '<span id="inlineXXX" style="color:red;"></span><br/>'+
                        'The value in red is the result displayed by this widget.</div>');
                    $('#inlineXXX').inlineValue({modelId:modelId, nodeId:'stock1', statistic:'final'});
                    break;

                case 'local_open':
                   $(newDiv).local_open();
                    break;

                case 'local_save':
                   $(newDiv).local_save({modelId:modelId});
                    break;

                case 'messages':
                    $(newDiv).messages();
                    SYSTO.trigger1({
                        triggering_file:'widget_presented.html', 
                        triggering_action:'Displaying "messages" widget"', 
                        listener_class: 'message_listener', 
                        event_type: 'click', 
                        argument_array: ['<p style="color:blue">This is an example of a message sent to the <b>messages</b> widget.</p><p>You can actually send any HTML.</p>']});
                    break;

                case 'multi_plotter':
                    $('.body').css({height:'300px', width:'700px'});
                    $(newDiv).multi_plotter({
                        packageId:packageId,
                        modelId:modelId, 
                        active:true,
                    });
                    //SYSTO.simulate(model);
                    SYSTO.trigger(
                        'widget_presenter.html',
                        'Displaying "multi_plotter" widget',
                        'change_model_listener',
                        'click',
                        [{packageId:packageId, oldModelId:'', newModelId:modelId}]
                    );
                    SYSTO.trigger(
                        'widget_presenter.html',
                        'Displaying "multi_plotter" widget',
                        'display_listener',
                        'click',
                        [{  packageId:packageId,
                            modelId:modelId,
                        }]
                    );
                    break;

                case 'multiple_sliders':
                    $(newDiv).css({width:'360px', 'overflow-x':'hidden', 'overflow-y':'auto'});
                    $(newDiv).multiple_sliders({
                        packageId:packageId,
                        modelId:modelId,
                        selectNode:function (node) {
                            if (node.type==='variable' && isEmpty(node.inarcList)) {
                                return true;
                            } else {
                                return false;
                            }
                        }
                    });
                    SYSTO.switchToModel(modelId);

                    SYSTO.trigger(
                        'pagemaker.html',
                        '#workspace mousedown',
                        'change_model_listener',
                        'click',
                        [{  packageId:packageId,
                            oldModelId:'',
                            newModelId:modelId}]
                    );
                    SYSTO.trigger(
                        'pagemaker.html',
                        '#workspace mousedown',
                        'display_listener',
                        'click',
                        [{  packageId:packageId,
                            modelId:modelId
                        }]
                    );
                    break;

                case 'phase_plane' :
                    $('.body').css({height:'400px', width:'400px'});
                    $(newDiv).phase_plane({modelId:modelId, nodeIdx:'stock1', nodeIdy:'stock3'});
                    break;

                case 'plotter':
                    $('.body').css({height:'340px', width:'550px'});
                    $(newDiv).plotter({
                        packageId:packageId,
                        modelId:modelId,
                        allowChangeOfModel: true,
                        canvasWidth:400, 
                        canvasHeight:250,
                        selectNode:function (node) {
                            if (node.type === 'stock') {
                                return true;
                            } else {
                                return false;
                            }
                        }
                    });
                    break;

                case 'runcontrol':
                    $('.body').css({height:'auto', width:'280px'});
                    $(newDiv).runcontrol({modelId:modelId});
                    break;

                case 'sketchgraph':
                    $('.body').css({height:'320px', width:'650px'});
                    $(newDiv).sketchgraph({
                                modelId: modelId,
                                nodeIdx: 'stock5',
                                nodeIdy: 'variable19'});
                    break;

                case 'slider1':
                    $(newDiv).slider1({
                        modelId:modelId, 
                        label:'birth_rate', 
                        value:0.5, 
                        minval:0, 
                        maxval:2});
                    break;

                case 'table':
                    $('.body').css({height:'320px', width:'250px', overflow:'auto'});
                    $(newDiv).table({modelId:modelId});
                    $(newDiv).css({'overflow-x':'auto', 'overflow-y':'auto'});
                    break;

                case 'technical':
                    $('.body').css({height:'320px', width:'auto'});
                    $('#widget_container_caption').html('<i>Please note: not all tabs have useful content in this live example.</i>');

                    $(newDiv).technical();
                    $('.technical-1').css({display:'block'});
                    SYSTO.trigger({
                        file:'pagemaker.html', 
                        action:'case: technical', 
                        event_type: 'technical_listener', 
                        parameters: {}
                    });
                    break;

                case 'text_editor':
                    $('.body').css({'height':'320px', width:'250px', overflow:'auto'});
                    $(newDiv).text_editor();
                    $(newDiv).css({'overflow-x':'auto', 'overflow-y':'auto'});
                    break;

                case 'text_plotter':
                    $('.body').css({'max-height':'320px', width:'auto', overflow:'auto'});
                    $(newDiv).text_plotter({modelId:modelId});
                    break;

                case 'toolbar':
                    $('.body').css({'max-height':'320px', width:'200px', overflow:'auto'});
                    $(newDiv).toolbar({
                        languageId:SYSTO.models.miniworld.meta.language,
                        modelId:modelId,
                        show_button_language:true,
                        show_button_new:true,
                        show_button_open:true,
                        show_button_save:true,
                        show_button_tutorial:true,
                        show_button_technical:true
                    });

                    break;

                default: 
            }       


            SYSTO.trigger(
                'pagemaker.html',
                '#workspace mousedown',
                'change_model_listener',
                'click',
                [{  packageId:SYSTO.state.currentPackageId,
                    oldModelId:'',
                    newModelId:SYSTO.state.currentModelId}]
            );
            SYSTO.trigger(
                'pagemaker.html',
                '#workspace mousedown',
                'display_listener',
                'click',
                [{  packageId:SYSTO.state.currentPackageId,
                    modelId:SYSTO.state.currentModelId
                }]
            );

        });
        $('#workspace').draggable({zIndex:50});

        //$('#rich_text_editor').rich_text_editor();


        function addOptionsToSelectModel() {
            for (var modelId in SYSTO.models) {
                var model = SYSTO.models[modelId];
                if (!model.meta.name) model.meta.name = modelId;
                var option = $('<option value="'+modelId+'" title="Model ID: '+modelId+'">'+model.meta.name+'</option>');
                $('#select_model').append(option);
            }
        }


    });

    function createNewModel() {
        var modelId = SYSTO.createNewModel('system_dynamics'); 
        var model = SYSTO.models[modelId];
        $('#select_model').append('<option value="'+modelId+'" title="'+modelId+'">'+model.meta.name+'</option>');

        alert('New model created: '+modelId+'('+model.meta.name+')');
    }

    
    function copyModel() {
        var modelId = $('#select_model').val();
        var model = SYSTO.models[modelId];
        var modelCopyId = SYSTO.copyModel(modelId); 
        var modelCopy = SYSTO.models[modelCopyId];
        $('#select_model').append('<option value="'+modelCopyId+'" title="'+modelCopyId+'">'+modelCopy.meta.name+'</option>');
        
        alert(modelId+'('+model.meta.name+') copied to '+modelCopyId+'('+modelCopy.meta.name+')');
    }

    function toggleHandle() {
        if ($('#toggleHandle').text() === 'Hide handle') {
            $('.handle').css('display','none');
            $('.deletor').css('display','none');
            $('#toggleHandle').text('Show handle');
        } else {
            $('.handle').css('display','block');
            $('.deletor').css('display','block');
            $('#toggleHandle').text('Hide handle');
        }
    }

	</script>

</head>
<body style="background-color:#808080;margin:0px; overflow:hidden;">

<div id="toolbar" style="position:relative; background-color:white;z-index:2000;">

<select id="select_package" style="z-index:2000;">
    <option value="package1">package1</option>
    <option value="package2">package2</option>
    <option value="package3">package3</option>
</select>

<select id="select_model">
</select>

<select id="select_widget">
    <option value="audio_plotter">audio_plotter</option>
    <option value="auto_layout">auto_layout</option>
    <option value="compare_models_text">compare_models</option>
    <option value="diagram" selected>diagram</option>
    <option value="equation_listing">equation_listing</option>
    <option value="import_im">import_im</option>
    <option value="import_vensim">import_vensim</option>
    <option value="import_xmile">import_xmile</option>
    <option value="inline_value">inline_value</option>
    <option value="local_open">local_open</option>
    <option value="local_save">local_save</option>
    <option value="messages">messages</option>
    <option value="multi_plotter">multi_plotter</option>
    <option value="multiple_sliders">multiple_sliders</option>
    <option value="phase_plane">phase_plane</option>
    <option value="plotter">plotter</option>
    <option value="runcontrol">runcontrol</option>
    <option value="slider1">slider1</option>
    <option value="table">table</option>
    <option value="technical">technical</option>
    <option value="text_editor">text_editor</option>
    <option value="text_plotter">text_plotter</option>
    <option value="toolbar">toolbar</option>
    <option value="tutorial">tutorial</option>
    <option value="tutorial_step">tutorial_step</option>
</select>

<!--button onclick="mode='adding_widget';" style="z-index:12000;">Add widget</button-->
<button onclick="createNewModel();" style="z-index:12000;">New model</button>
<button onclick="copyModel();" style="z-index:12000;">Copy model</button>
<button id="toggleHandle" onclick="toggleHandle();" style="z-index:12000;">Hide handle</button>
<!--div id="rich_text_editor"></div-->
</div>

<div id="workspace_container" style="float:left; clear:both; z-index:-100;padding:0px; background-color:white; ">
    <div id="workspace">
    </div>
</div>

<script>
</script>
</body>
</html>
